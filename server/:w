import inspect

from server.basic.code import no_login


class jbsProcessorMixin(object):
    """
    jbsProcessorMixin, add cookie support for processor
    """
    def set_cookie(self, cookie):
        """
        set the cookie for the processor
        it must be call before operation

        Args:
            cookie (cookiejar): the cookie
        """
        self.cookie = cookie

class CheckCookieMethod(object):
    def __init__(self, func, im_self):
        self.func = func
        self.func_self = im_self

    def __get__(self, obj, cls=None):
        def wrapper(*args, **kwargs):
            if 'cookie' not in self.func_self:
                return no_login
            else:
                ret = self.func(*args, **kwargs)
                return ret
        return wrapper

def add_cookie_check(exclude_methods=[]):
    def decorated(cls):
        def wrapper(*args, **kwargs):
            for name, method in inspect.getmembers(cls, inspect.ismethod):
                if name not in exclude_methods and not inspect.isclass(method.im_self):
                    print name
                    setattr(cls, name, CheckCookieMethod(method, method.im_self))
            return cls
        return wrapper
    return decorated
